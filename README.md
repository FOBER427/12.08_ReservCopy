# 12.08_ReservCopy# 12.8 Резервное копирование баз данных - Хомяков Антон

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

#### *Решение:*

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

Ключевые требования это - "увеличить надёжность работы баз данных и их резервного копирования", плюс БД использует финансовая компания, а значит данные имеют высокую ценность. Так как в условии написано, что финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования, значит она уже использует менее надежные способы. В зависимости от требований и интенсивности использования БД, подошли бы несколько способов резервного копирования:
1. Полное резервное копирование (Full backup);
2. Полное резервное копирование с дифференциальным бэкапом.

#### Чем хорошо:
- Простота восстановления - разворачивается как есть.
- Один файл = одна точка восстановления.

#### Недостатки:
- Большой объем данных.
- Долгое время на бэкап и восстановление при больших базах.

Интенсивность резервного копирования и дифференциального бэкапа зависит от требований и условий использования БД.


1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1. Если данных не много и интенсивность использования низкая, то полное резервное копирование каждый день с дифференциальным бэкапом каждый час. Этот вариант надежнее, но использует больше места для хранения.
2. Если данных много и интенсивность использования высокая, то полное резервное копирование каждый день с инкрементным бэкапом каждый час. Этот вариант менее надежный, но использует меньше места для хранения.

#### Как это работает на практике:
- в 02:00 делается полный бэкап.
- каждый час - инкриментный.
- журналы транзакций пишутся постоянно.
- если что-то пошло не так в 14:27, можно откатить базу до 14:00 по инкрименету, а потом "докатить" изменения из логов до 14:27.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Да, возможен. Репликация. В случае поломки БД и краха Master-сервера можно назначить «новый Master-сервер» на один из Slave-серверов и перенаправить клиентов на него. После устранения неисправностей делается обратное переназначение и перенаправление.

#### Master-Slave репликация + мониторинг:
Минус: может быть небольшая задержка при переключении, если нет автопереключения.

#### Master-Master (или Multi-Master) + балансировка:
Минус: сложнее синхронизировать, возможно конфликтное редактирование данных, нужны механизмы разрешения.
---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

*Приведите ответ в свободной форме.*

#### *Решение:*

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

Команда резервирования данных:
```bash
pg_dump sakila > sakiladb.sql
```
Если нужен другой формат, то указываем параметр -Fc: 
```bash
pg_dump -Fc sakila > sakiladb.dump
```
Если БД принадлежит другому пользователю, то указываем параметр -U username:
```bash
pg_dump -U username sakila > sakiladb.sql
```
[Ссылка на документацию PostgreSQL, pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html)

Команда восстановления БД:
```bash
pg_restore -d sakila sakiladb.sql
```
[Ссылка на документацию PostgreSQL, pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html)

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

*Приведите ответ в свободной форме.*

#### *Решение:*

Так как инкрементное резервное копирование в MySQL требует полной копии в качестве базовой точки, первым шагом выполняется полный резервный бэкап базы данных. Он создаёт опорный снимок, на основе которого в будущем будут строиться приращённые копии (по LSN — Log Sequence Number) Полная резервная копия.
```bash
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi \
   backup-to-image
```
В данном примере используется опция --incremental-base=history:last_backup, которая извлекает LSN последней успешной полной или частичной резервной копии (не TTS) из mysql.backup_history таблицы и на этой основе выполняет инкрементную резервную копию.

[Ссылка на документацию MySQL](https://dev.mysql.com/doc/mysql-enterprise-backup/8.2/en/mysqlbackup.incremental.html#meb-incremental-considerations)


#### Чтобы восстановить базу, нужно:
- Применить полную резервную копию.
- Последовательно накладывать все инкрементные образы в нужном порядке/

#### Возможна ли автоматизация?
- Да, процесс можно полностью автоматизировать с помощью cron и shell-скриптов:
#### Пример расписания:
Полный бэкап — каждое воскресенье в 03:00:
```
0 3 * * 0 /home/dbadmin/scripts/full_backup.sh
```
Инкрементный бэкап — ежедневно в 03:30:
```
30 3 * * 1-6 /home/dbadmin/scripts/incremental_backup.sh
```
### Вывод:
Инкрементное резервное копирование в MySQL — мощный инструмент, позволяющий экономить место и время, сохраняя только изменения. Оно требует предварительного полного бэкапа и может быть легко встроено в систему автоматизации. Для промышленных задач стоит использовать также шифрование, мониторинг целостности и систему уведомлений.
---
